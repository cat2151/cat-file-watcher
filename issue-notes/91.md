# issue READMEにある30秒タイムアウトの意味がわからないので整理する #91
[issues #91](https://github.com/cat2151/cat-file-watcher/issues/91)

## 疑問

前提：
- 1時間かかるlong taskも、タイムアウトせず実行できている

疑問：
- ではこの30秒のタイムアウトとは何か？

## 調査結果

### 30秒タイムアウトの正体

**30秒タイムアウトは「フォアグラウンドで実行されるコマンド」のタイムアウトです。**

`src/command_executor.py` の66行目:
```python
result = subprocess.run(command, shell=True, capture_output=False, text=True, timeout=30, cwd=cwd)
```

この `timeout=30` は、subprocess.run()がコマンドの完了を待つ最大時間を指定しています。

### なぜ1時間のタスクがタイムアウトしないのか？

バックグラウンド実行（`&` を使用）すると、コマンド自体は即座に完了します:

**フォアグラウンド実行の場合:**
```toml
command = "sleep 60"  # 60秒待つ → 30秒でタイムアウト
```
→ 30秒でタイムアウトエラーが発生

**バックグラウンド実行の場合:**
```toml
command = "sleep 3600 &"  # バックグラウンドで実行
```
→ subprocess.run()は即座に完了（0.01秒程度）し、タイムアウトしない
→ sleep 3600 プロセスはバックグラウンドで1時間動き続ける

### 実験による検証

以下のテストを実行して確認:

```python
# Test 1: 5秒のフォアグラウンド実行（30秒以内）
result = subprocess.run("sleep 5 && echo 'done'", shell=True, timeout=30)
# → Success! Elapsed: 5.03s

# Test 2: 35秒のフォアグラウンド実行（30秒超過）
result = subprocess.run("sleep 35 && echo 'done'", shell=True, timeout=30)
# → Timeout! Elapsed: 30.00s  ← タイムアウト発生

# Test 3: 60秒のバックグラウンド実行
result = subprocess.run("sleep 60 &", shell=True, timeout=30)
# → Success! Elapsed: 0.00s  ← 即座に完了
```

## 結論

### 30秒タイムアウトとは何か？

**「フォアグラウンドで実行されるコマンドのプロセス待機時間の上限」**

- フォアグラウンド実行のコマンドは30秒以内に完了する必要がある
- 30秒を超えるとタイムアウトエラーが発生し、プロセスは強制終了される
- バックグラウンド実行（`&`）を使用すれば、subprocess.run()は即座に完了するためタイムアウトしない

### 現在のREADMEの問題点

README.ja.md（204行目）とREADME.md（203行目）の記述:
> コマンド実行のタイムアウトは30秒に設定されており、それを超えるとタイムアウトエラーが発生します。

この記述は誤解を招きやすい:
- ❌ **誤解**: すべてのコマンドが30秒で強制終了される
- ✅ **実際**: フォアグラウンド実行のコマンドのみが30秒でタイムアウトする
- ✅ **実際**: バックグラウンド実行（`&`）を使えば長時間タスクも実行可能

### 推奨する修正内容

READMEの該当箇所を以下のように明確化すべき:

**修正前:**
> コマンド実行のタイムアウトは30秒に設定されており、それを超えるとタイムアウトエラーが発生します。

**修正後:**
> フォアグラウンドで実行されるコマンドのタイムアウトは30秒に設定されており、それを超えるとタイムアウトエラーが発生します。長時間実行が必要なコマンドの場合は、バックグラウンド実行（`&` を使用）してください。バックグラウンド実行されたコマンドは、subprocess.run()が即座に完了するため、タイムアウトの制限を受けません。

## 実装箇所の確認

### タイムアウトが設定されている箇所

`src/command_executor.py` 66行目:
```python
result = subprocess.run(command, shell=True, capture_output=False, text=True, timeout=30, cwd=cwd)
```

### タイムアウトエラーのハンドリング

`src/command_executor.py` 73-77行目:
```python
except subprocess.TimeoutExpired as e:
    error_msg = f"Command timed out after 30 seconds for '{filepath}'"
    TimestampPrinter.print(f"Error: {error_msg}", Fore.RED)
    ErrorLogger.log_error(error_log_file, error_msg, e)
    raise
```

## 参考資料

- issue #57: commandが終了するまでは他のファイルの更新監視は行われないのか？
  - 「30秒のタイムアウト制限」について言及されている
- issue #30: exception発生時やエラー時のログ出力
  - タイムアウトエラーのログ記録について実装されている

