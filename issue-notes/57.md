# issue commandが終了するまでは他のファイルの更新監視は行われないのか？すべてのファイルの更新監視を並列で行う方法はあるか？を明確にする #57
[issues #57](https://github.com/cat2151/cat-file-watcher/issues/57)

## 質問への回答

**質問**: 例えばcommandが1分間終了しない場合、その1分間は他のファイルの更新監視は行われないのでしょうか？

**回答**: はい、その通りです。現在の実装では、コマンドは**順次実行（シーケンシャル）**されます。

## 現在の動作仕様

### コマンド実行の仕組み

1. **順次処理**: 設定ファイルに記載された順番で、ファイルを1つずつチェックします
2. **ブロッキング実行**: ファイルの変更を検知してコマンドを実行する際、そのコマンドが完了（または30秒のタイムアウト）するまで、次のファイルのチェックは行われません
3. **タイムアウト制限**: 各コマンドには30秒のタイムアウトが設定されており、30秒を超えるとタイムアウトエラーが発生します

### 具体例

設定ファイルで以下のように複数ファイルを監視している場合：

```toml
[files]
"file1.txt" = { command = "sleep 25 && echo 'done1'" }
"file2.txt" = { command = "echo 'done2'" }
"file3.txt" = { command = "echo 'done3'" }
```

もし `file1.txt` が更新されてコマンドが実行されると：
- `file1.txt` のコマンド（25秒かかる）が実行されている間、`file2.txt` と `file3.txt` の監視は停止します
- この25秒間に `file2.txt` や `file3.txt` が更新されても、`file1.txt` のコマンドが完了するまで検知されません
- `file1.txt` のコマンド完了後、次のメインループで `file2.txt` と `file3.txt` の変更が検知されます

### コード内での実装箇所

`src/cat_file_watcher.py` の `_check_files()` メソッド（122-179行目）:
```python
for filename, settings in files_config.items():
    # ... ファイルの変更チェック ...
    if current_timestamp != self.file_timestamps[filename]:
        CommandExecutor.execute_command(settings["command"], filename, settings, self.config)
        # ↑ このメソッドはブロッキング実行（完了まで待機）
```

`src/command_executor.py` の `execute_command()` メソッド（55行目）:
```python
result = subprocess.run(command, shell=True, capture_output=False, text=True, timeout=30, cwd=cwd)
# ↑ subprocess.run() はブロッキング呼び出し
```

## 並列実行について

### 現状
現在の実装では、ファイル監視とコマンド実行の**並列化はサポートされていません**。

### 並列実行が必要な場合
もし複数のファイルを真に並列で監視・実行したい場合、以下のような対応が考えられます：

1. **マルチプロセス/マルチスレッド化**: Pythonの `multiprocessing` や `threading` を使用してコマンドを非同期実行
2. **非同期I/O**: `asyncio` と `subprocess.Popen()` を組み合わせて非同期実行
3. **複数インスタンス起動**: 設定ファイルを分割して、複数の `cat-file-watcher` インスタンスを個別に起動

ただし、現在のツールのコンセプトは「シンプルでメンテしやすいTOML記述」を優先しているため、並列実行の実装は将来的な拡張として検討されます。

## 結論

- ✅ **コマンド実行は順次処理**: あるファイルのコマンド実行中は、他のファイルの監視は一時停止します
- ✅ **30秒のタイムアウト制限**: 1つのコマンドは最大30秒までしか実行できません
- ✅ **長時間実行が必要な場合**: コマンド内でバックグラウンド実行（`&` を使用）するか、別プロセスで起動する工夫が必要です
- ❌ **並列実行は未サポート**: 現在の実装では、複数ファイルの監視・実行を並列化する機能はありません

この仕様は、README.ja.md と README.md の「動作の仕組み」セクションに追記されます。

