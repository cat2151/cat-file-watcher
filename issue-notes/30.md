# issue exception発生時やエラー時は、tomlで指定したerror logにそれを出力する。発生時刻とstack traceも出力する。log出力しつつ、raiseやエラー終了もする（つまりFail-fast systemにする） #30
[issues #30](https://github.com/cat2151/cat-file-watcher/issues/30)

## 結論 / Conclusion

エラーログ機能を実装しました。TOMLで`error_log_file`を指定すると、すべての例外とエラーがタイムスタンプとスタックトレースと共にログファイルに記録されます。エラーをログに記録した後、例外を再スローまたはエラー終了することで、Fail-fastシステムを実現しています。

Error logging functionality has been implemented. When `error_log_file` is specified in TOML, all exceptions and errors are logged to the error log file with timestamps and stack traces. After logging errors, exceptions are re-raised or the system exits with an error, implementing a fail-fast system.

## 実装内容 / Implementation

### 新しいモジュール / New Module

1. **`src/error_logger.py`**: エラーロギング機能を提供する新しいモジュール
   - `ErrorLogger.log_error()`: タイムスタンプ、エラーメッセージ、スタックトレースをエラーログファイルに書き込む
   - `error_log_file`がNoneの場合は何もしない（グレースフルに処理）
   - ログファイルへの書き込みに失敗した場合はstderrに警告を出力

### 変更箇所 / Modified Files

1. **`src/config_loader.py`**:
   - `ErrorLogger`をインポート
   - `load_config()`でエラー発生時にerror_log_fileにログ記録
   - `FileNotFoundError`, `TomlDecodeError`, その他の例外をログに記録
   - エラーをログ記録した後、`sys.exit(1)`で終了（Fail-fast）

2. **`src/command_executor.py`**:
   - `ErrorLogger`をインポート
   - `execute_command()`でコマンド実行のエラーをログ記録:
     - コマンドが0以外の終了コードで終了した場合
     - タイムアウトが発生した場合（30秒）- ログ記録後に例外を再スロー
     - その他の例外が発生した場合 - ログ記録後に例外を再スロー
   - `_write_to_log()`でログファイル書き込みエラーをerror_log_fileに記録

3. **`src/cat_file_watcher.py`**:
   - `ErrorLogger`をインポート
   - `_check_config_file()`で設定ファイルのリロードエラーをログ記録
   - `_check_files()`で各ファイル処理中のエラーをログ記録し、他のファイルの処理を継続

4. **`src/__init__.py`**:
   - `ErrorLogger`をエクスポートリストに追加

5. **`examples/config.example.toml`**:
   - `error_log_file`設定オプションの説明とコメント例を追加

### ログの内容 / Log Content

エラーログには以下の情報が含まれます:
- タイムスタンプ: `[YYYY-MM-DD HH:MM:SS]` 形式
- エラーメッセージ
- 例外タイプ（該当する場合）
- 例外メッセージ（該当する場合）
- スタックトレース（該当する場合）

Example error log entry:
```
[2025-10-10 23:46:51] ERROR: Command timed out after 30 seconds for 'test.txt'
Exception type: TimeoutExpired
Exception message: Command 'sleep 60' timed out after 30 seconds
Stack trace:
  Traceback (most recent call last):
    File "command_executor.py", line 42, in execute_command
      result = subprocess.run(...)
  subprocess.TimeoutExpired: Command 'sleep 60' timed out after 30 seconds

```

### Fail-fastシステム / Fail-fast System

エラーをログに記録した後、以下のように処理します:
- **設定ファイルのエラー**: ログ記録後に`sys.exit(1)`で終了
- **コマンドタイムアウト**: ログ記録後に例外を再スロー
- **コマンド実行エラー**: ログ記録後に例外を再スロー
- **ファイル処理エラー**: ログ記録後、他のファイルの処理を継続（部分的なFail-fast）
- **設定リロードエラー**: ログ記録後、前の設定で処理を継続

## テスト / Tests

12個の新しいテストを追加（すべて成功）:
- `test_error_logger_basic_message`: 基本的なエラーメッセージのログ記録
- `test_error_logger_with_exception`: 例外とスタックトレースのログ記録
- `test_error_logger_none_file`: error_log_fileがNoneの場合の処理
- `test_error_logger_appends_to_file`: 既存ログへの追記
- `test_config_loader_logs_file_not_found`: 設定ファイルが見つからない場合
- `test_config_loader_logs_parse_error`: TOML解析エラー
- `test_command_executor_logs_timeout_error`: コマンドタイムアウトエラー
- `test_command_executor_logs_command_failure`: コマンド実行失敗
- `test_command_executor_logs_write_log_error`: ログファイル書き込みエラー
- `test_file_watcher_check_files_logs_errors`: ファイル処理エラー
- `test_file_watcher_config_reload_logs_errors`: 設定リロードエラー
- `test_error_log_timestamp_format`: タイムスタンプ形式の検証

全テスト: 75個（63個既存 + 12個新規）すべて成功

## 後方互換性 / Backward Compatibility

既存の設定ファイルは変更なしで動作します。`error_log_file`パラメータはオプションです。指定されていない場合、エラーはコンソールに出力されますが、エラーログファイルには記録されません。

## 使用例 / Usage Example

```toml
# config.toml
default_interval = 1000
error_log_file = "error.log"

[files]
"test.txt" = { command = "echo test" }
```

エラーが発生した場合、`error.log`に記録されます:
```
[2025-10-10 23:46:51] ERROR: Command failed for 'test.txt' with exit code 1
Command: invalid_command
Stderr: /bin/sh: invalid_command: command not found

```


