# issue リファクタリング計画書を作成する #95
[issues #95](https://github.com/cat2151/cat-file-watcher/issues/95)

## エグゼクティブサマリー / Executive Summary

このリファクタリング計画は、cat-file-watcherプロジェクトのコード品質を向上させ、変更容易性と可読性を高めることを目的としています。

**重要な発見 / Key Findings:**
- 現在のコードベースは比較的良好な状態です
- 主要なソースファイルは21行から335行の範囲
- いくつかのテストファイルが100行を大きく超えています（最大536行）
- いくつかの関数が長すぎます（最大84行）

**静的解析ツールの必要性について:**
> **結論: 今すぐ導入する必要はありません**
> 
> このコンテキストとコードベースだけで十分リファクタリング判断ができます。理由：
> - コードベースは比較的小規模（約6,000行）
> - 構造は明確で理解しやすい
> - 既存のRuffによるリンティングで十分
> - 手動分析で問題箇所を特定済み
> - 導入コストに対するメリットが現時点では小さい
> 
> ただし、将来的には以下のツールが有用かもしれません：
> - `radon`（循環的複雑度測定）
> - `pylint`（より詳細なコード分析）
> - `mccabe`（複雑度チェック）

---

## 1. 現状分析 / Current State Analysis

### 1.1 ファイルサイズ分析 / File Size Analysis

#### ソースファイル (src/) - 100行超過
| ファイル | 行数 | 状態 | 優先度 |
|---------|------|------|--------|
| `src/config_loader.py` | 335行 | ❌ 要リファクタリング | 高 |
| `src/cat_file_watcher.py` | 246行 | ❌ 要リファクタリング | 高 |
| `src/command_executor.py` | 182行 | ❌ 要リファクタリング | 中 |
| `src/process_detector.py` | 127行 | ❌ 要リファクタリング | 中 |
| `src/time_period_checker.py` | 124行 | ❌ 要リファクタリング | 中 |

#### ソースファイル (src/) - 100行以下
| ファイル | 行数 | 状態 |
|---------|------|------|
| `src/timestamp_printer.py` | 50行 | ✓ 良好 |
| `src/interval_parser.py` | 50行 | ✓ 良好 |
| `src/error_logger.py` | 47行 | ✓ 良好 |
| `src/__main__.py` | 27行 | ✓ 良好 |
| `src/__init__.py` | 21行 | ✓ 良好 |

#### テストファイル (tests/) - 100行超過
| ファイル | 行数 | 状態 | 優先度 |
|---------|------|------|--------|
| `tests/test_terminate_if_process.py` | 536行 | ❌ 要リファクタリング | 高 |
| `tests/test_commands_and_processes_sections.py` | 380行 | ❌ 要リファクタリング | 高 |
| `tests/test_external_files.py` | 361行 | ❌ 要リファクタリング | 高 |
| `tests/test_cat_file_watcher.py` | 300行 | ❌ 要リファクタリング | 中 |
| `tests/test_error_logging.py` | 290行 | ❌ 要リファクタリング | 中 |
| `tests/test_time_periods.py` | 253行 | ❌ 要リファクタリング | 中 |
| `tests/test_command_logging.py` | 246行 | ❌ 要リファクタリング | 中 |
| `tests/test_timestamp.py` | 228行 | ❌ 要リファクタリング | 低 |
| `tests/test_suppression_logging.py` | 211行 | ❌ 要リファクタリング | 低 |
| `tests/test_new_interval_format.py` | 210行 | ❌ 要リファクタリング | 低 |
| `tests/test_directory_monitoring.py` | 174行 | ❌ 要リファクタリング | 低 |
| `tests/test_cwd.py` | 204行 | ❌ 要リファクタリング | 低 |
| `tests/test_multiple_empty_filenames.py` | 196行 | ❌ 要リファクタリング | 低 |
| `tests/test_empty_filename.py` | 158行 | ❌ 要リファクタリング | 低 |
| `tests/test_main_loop_interval.py` | 157行 | ❌ 要リファクタリング | 低 |
| `tests/test_config_reload.py` | 153行 | ❌ 要リファクタリング | 低 |
| `tests/test_colorama.py` | 136行 | ❌ 要リファクタリング | 低 |
| `tests/test_interval_parser.py` | 122行 | ❌ 要リファクタリング | 低 |
| `tests/test_intervals.py` | 101行 | ❌ 要リファクタリング | 低 |

### 1.2 関数複雑度分析 / Function Complexity Analysis

#### 30行超過の関数（循環的複雑度が高い可能性）

**src/config_loader.py:**
- `_merge_external_files`: 84行 - 外部ファイルマージロジック
- `load_config`: 51行 - 設定ファイル読み込み
- `_validate_processes_format`: 41行 - プロセスセクションバリデーション
- `_validate_commands_format`: 37行 - コマンドセクションバリデーション
- `_validate_files_format`: 35行 - ファイルセクションバリデーション

**src/cat_file_watcher.py:**
- `_check_files`: 79行 - ファイルチェックメインロジック
- `_calculate_main_loop_interval`: 43行 - メインループ間隔計算
- `_check_config_file`: 38行 - 設定ファイルチェック

**src/command_executor.py:**
- `execute_command`: 57行 - コマンド実行
- `_handle_process_termination`: 49行 - プロセス終了処理

**src/process_detector.py:**
- `get_all_matching_processes`: 38行 - プロセス検索
- `get_matching_process`: 36行 - プロセスマッチング

---

## 2. リファクタリング基準 / Refactoring Criteria

### 2.1 優先順位付けの基準

以下の基準に基づいて優先順位を決定します：

1. **ファイルサイズ** （Weight: 40%）
   - 100行以下: 優先度なし
   - 101-200行: 低優先度
   - 201-300行: 中優先度
   - 301行以上: 高優先度

2. **関数の長さ** （Weight: 30%）
   - 30行以下: 優先度なし
   - 31-50行: 低優先度
   - 51-70行: 中優先度
   - 71行以上: 高優先度

3. **循環的複雑度（推定）** （Weight: 20%）
   - 関数内のif/for/while文の数
   - ネストの深さ
   - try/exceptブロックの数

4. **変更頻度** （Weight: 10%）
   - 頻繁に変更されるコードほど優先度が高い

### 2.2 リファクタリングを行う基準

以下の条件に該当する場合、リファクタリングを実施します：

✅ **必須リファクタリング:**
- ファイルが300行を超えている
- 関数が70行を超えている
- 明らかに複数の責務を持っている

⚠️ **推奨リファクタリング:**
- ファイルが200行を超えている
- 関数が50行を超えている
- ネストが3階層以上ある

💡 **検討レベル:**
- ファイルが100行を超えている
- 関数が30行を超えている
- コメントなしでは理解が難しい

---

## 3. リファクタリング計画 / Refactoring Plan

### Phase 1: 高優先度ファイル（必須）

#### 3.1 `src/config_loader.py` (335行)

**現在の責務:**
- TOML設定ファイル読み込み
- ファイル/コマンド/プロセスセクションバリデーション
- 外部ファイルマージ
- セクション間のマージ
- インターバル計算

**提案される分割:**

1. **新ファイル: `src/config_validator.py`** (約150行)
   - `validate_files_format()`
   - `validate_commands_format()`
   - `validate_processes_format()`
   - 各種バリデーションヘルパー関数

2. **新ファイル: `src/external_config_merger.py`** (約100行)
   - `merge_external_files()`
   - `merge_sections()`
   - マージロジック

3. **リファクタリング後の `src/config_loader.py`** (約85行)
   - `load_config()` - シンプルな調整役
   - `get_interval_for_file()`
   - 他のモジュールの組み合わせ

**期待される効果:**
- 各ファイルが100行以下
- 単一責任原則の遵守
- テストの分離が容易
- 理解しやすいコード

#### 3.2 `src/cat_file_watcher.py` (246行)

**現在の責務:**
- ファイル監視メインロジック
- 設定ファイルチェック
- タイムスタンプ管理
- インターバル計算

**提案される分割:**

1. **新ファイル: `src/file_monitor.py`** (約100行)
   - `check_files()` を複数の小さな関数に分割
   - `_should_skip_file()` - スキップ判定
   - `_process_file_entry()` - 個別ファイル処理
   - `_handle_empty_filename()` - 空ファイル名処理
   - `_handle_regular_file()` - 通常ファイル処理

2. **リファクタリング後の `src/cat_file_watcher.py`** (約100行)
   - `__init__()`
   - `run()`
   - `_check_config_file()`
   - `_calculate_main_loop_interval()`
   - 調整役として機能

**リファクタリングアプローチ:**
- `_check_files()` 関数を小さな関数に分割
- 各小関数は10-20行程度
- 明確な関数名で自己説明的に

#### 3.3 `tests/test_terminate_if_process.py` (536行)

**現在の責務:**
- プロセス終了機能の包括的テスト
- 23個のテストケース

**提案される分割:**

1. **新ファイル: `tests/test_terminate_if_process_basic.py`** (約150行)
   - 基本的な単一プロセス終了テスト
   - プロセスが見つからない場合のテスト
   - エラーケースの基本テスト

2. **新ファイル: `tests/test_terminate_if_process_array.py`** (約200行)
   - 配列形式のテスト
   - 複数パターンのテスト
   - 混合ケースのテスト

3. **新ファイル: `tests/test_terminate_if_process_edge_cases.py`** (約150行)
   - エッジケース
   - ProcessDetectorの拡張機能テスト
   - 境界値テスト

4. **削除: `tests/test_terminate_if_process.py`**
   - 3つの新ファイルに完全に置き換え

**期待される効果:**
- 各テストファイルが200行以下
- テストの目的が明確
- テスト実行時間の並列化が可能
- 失敗時のデバッグが容易

#### 3.4 `tests/test_commands_and_processes_sections.py` (380行)

**提案される分割:**

1. **新ファイル: `tests/test_commands_section.py`** (約130行)
   - `[[commands]]`セクションの全テスト

2. **新ファイル: `tests/test_processes_section.py`** (約130行)
   - `[[processes]]`セクションの全テスト

3. **新ファイル: `tests/test_sections_integration.py`** (約120行)
   - 複数セクションの統合テスト
   - セクション間の相互作用テスト

#### 3.5 `tests/test_external_files.py` (361行)

**提案される分割:**

1. **新ファイル: `tests/test_external_files_basic.py`** (約120行)
   - 基本的な外部ファイル読み込み
   - 単一セクションのテスト

2. **新ファイル: `tests/test_external_files_validation.py`** (約120行)
   - バリデーションエラーテスト
   - フォーマットエラーテスト

3. **新ファイル: `tests/test_external_files_advanced.py`** (約120行)
   - 複数セクションの統合
   - 相対パス処理
   - エッジケース

### Phase 2: 中優先度ファイル（推奨）

#### 3.6 `src/command_executor.py` (182行)

**提案されるリファクタリング:**

関数分割のみで対応可能:

1. `execute_command()` (57行) を分割:
   - `_check_process_suppression()` - プロセス抑制チェック
   - `_execute_shell_command()` - シェルコマンド実行
   - `_handle_command_result()` - 結果処理

2. `_handle_process_termination()` (49行) を分割:
   - `_terminate_single_process()` - 単一プロセス終了
   - `_handle_multiple_matches()` - 複数マッチ処理

**期待される効果:**
- 各関数が20-30行程度
- 循環的複雑度の低減
- テストが容易

#### 3.7 `src/process_detector.py` (127行)

**提案されるリファクタリング:**

関数分割のみで対応:

1. `get_all_matching_processes()` (38行) を分割:
   - `_compile_process_pattern()` - 正規表現コンパイル
   - `_filter_matching_processes()` - プロセスフィルタリング

2. `get_matching_process()` (36行) を分割:
   - `_find_first_match()` - 最初のマッチ検索
   - `_format_process_info()` - プロセス情報フォーマット

#### 3.8 `src/time_period_checker.py` (124行)

**提案されるリファクタリング:**

このファイルは既に適切に構造化されているため、小さな改善のみ:
- 長い関数を小さな関数に分割
- ドキュメント文字列の充実

#### 3.9-3.14 中規模テストファイル (200-300行)

各テストファイルを2つのファイルに分割:
- 基本テスト
- 高度なテスト/エッジケース

### Phase 3: 低優先度ファイル（検討レベル）

100-200行のテストファイルは、特に問題がない限り現状維持。
必要に応じて将来のリファクタリングで対応。

---

## 4. リファクタリング実行方針 / Refactoring Execution Strategy

### 4.1 段階的アプローチ

1. **Phase 1** (高優先度) → 即座に実行すべき
   - `src/config_loader.py` の分割
   - `src/cat_file_watcher.py` の分割
   - 最大のテストファイル3つの分割

2. **Phase 2** (中優先度) → 3-6ヶ月以内
   - 中規模ソースファイルの関数分割
   - 中規模テストファイルの分割

3. **Phase 3** (低優先度) → 必要に応じて
   - 小規模ファイルの改善
   - ドキュメント充実

### 4.2 各リファクタリングの手順

各ファイルのリファクタリングは以下の手順で実施:

1. **分析** (1-2時間)
   - 現在の責務を洗い出し
   - 依存関係の確認
   - 分割ポイントの特定

2. **テスト準備** (1-2時間)
   - 既存テストが全て通ることを確認
   - リファクタリング後も同じテストが使えることを確認

3. **実装** (3-4時間)
   - 新ファイル作成
   - コード移動
   - import文の調整

4. **検証** (1-2時間)
   - 全テスト実行（172テスト全て通ることを確認）
   - Ruffによるコード品質チェック
   - 手動での動作確認

5. **ドキュメント更新** (30分-1時間)
   - コード内ドキュメント
   - README必要に応じて更新

**各ファイルのリファクタリング: 合計6-11時間**

### 4.3 リスク管理

**リスク軽減策:**

1. **テスト駆動**
   - リファクタリング前後でテストを実行
   - 172個の既存テストが全て通ることを確認

2. **段階的な変更**
   - 1つのファイルずつリファクタリング
   - 各変更後にコミット

3. **後方互換性**
   - 既存のimport文が動作し続けることを保証
   - 古い関数名を一時的にラッパーとして維持

4. **レビュー**
   - 各PRは小さく保つ（1ファイルのリファクタリング = 1PR）
   - コードレビューで品質を確保

---

## 5. 成功の測定基準 / Success Metrics

### 5.1 定量的指標

リファクタリング成功の測定基準:

| 指標 | 現状 | 目標 | 測定方法 |
|------|------|------|---------|
| 100行超過のソースファイル | 5/10 (50%) | 0/12 (0%) | `wc -l src/*.py` |
| 100行超過のテストファイル | 19/21 (90%) | 5/25 (20%) | `wc -l tests/*.py` |
| 70行超過の関数 | 2個 | 0個 | 手動分析 |
| 50行超過の関数 | 4個 | 0-1個 | 手動分析 |
| テスト成功率 | 172/172 (100%) | 172+/172+ (100%) | `pytest` |
| Ruffエラー | 0 | 0 | `ruff check` |

### 5.2 定性的指標

- ✅ コードが自己説明的（コメント削減可能）
- ✅ 各ファイル/関数が単一責任を持つ
- ✅ 新規開発者が理解しやすい
- ✅ 変更が局所的で済む（影響範囲が小さい）
- ✅ テストが書きやすい/実行しやすい

---

## 6. タイムライン / Timeline

### Phase 1: 高優先度（1-2週間）

| タスク | 推定工数 | 担当 |
|--------|---------|------|
| `src/config_loader.py` 分割 | 8時間 | TBD |
| `src/cat_file_watcher.py` 分割 | 10時間 | TBD |
| `tests/test_terminate_if_process.py` 分割 | 6時間 | TBD |
| `tests/test_commands_and_processes_sections.py` 分割 | 5時間 | TBD |
| `tests/test_external_files.py` 分割 | 5時間 | TBD |
| **合計** | **34時間** | |

### Phase 2: 中優先度（1-2ヶ月）

| タスク | 推定工数 | 担当 |
|--------|---------|------|
| `src/command_executor.py` 改善 | 4時間 | TBD |
| `src/process_detector.py` 改善 | 3時間 | TBD |
| `src/time_period_checker.py` 改善 | 2時間 | TBD |
| 中規模テストファイル分割（6ファイル） | 18時間 | TBD |
| **合計** | **27時間** | |

### Phase 3: 低優先度（必要に応じて）

- 小規模な改善
- ドキュメント充実
- コメント整理

---

## 7. 参考資料 / References

### 7.1 過去のリファクタリング事例

- [Issue #16 Refactoring Summary](./16-refactoring-summary.md)
  - 221行のファイルを95行に分割
  - 339行のテストを複数ファイルに分割
  - 全て100行以下に成功

- [Issue #19 Refactoring Summary](./19-refactoring-summary.md)
  - テストディレクトリ構造の改善
  - 40テスト全て成功維持

### 7.2 コーディング基準

- [GitHub Copilot Instructions](.github/copilot-instructions.md)
- リーダブルコード原則
- Python PEP 8
- プロジェクト独自の100行ルール

### 7.3 推奨リーディング

- "Refactoring: Improving the Design of Existing Code" by Martin Fowler
- "Clean Code" by Robert C. Martin
- "The Art of Readable Code" by Dustin Boswell & Trevor Foucher

---

## 8. 結論 / Conclusion

### 8.1 要約

cat-file-watcherプロジェクトは比較的良好な状態ですが、いくつかの改善機会があります：

**即座のアクション（Phase 1）:**
1. `src/config_loader.py` (335行) → 3ファイルに分割
2. `src/cat_file_watcher.py` (246行) → 2ファイルに分割
3. 大規模テストファイル3つを分割

**期待される成果:**
- ハルシネーションリスクの大幅削減
- コードの可読性向上
- 変更容易性の向上
- メンテナンス性の向上

**静的解析ツール:**
現時点では不要。手動分析とRuffで十分。

### 8.2 次のステップ

1. ✅ このリファクタリング計画をレビュー
2. ⬜ Phase 1の実行開始（個別issueを起票）
3. ⬜ 各リファクタリング後にメトリクスを測定
4. ⬜ Phase 1完了後、Phase 2の詳細計画を策定

---

## 9. 承認 / Approval

- **計画作成日**: 2025-10-15
- **作成者**: GitHub Copilot
- **レビュー状態**: Pending
- **承認状態**: Pending

---

## 変更履歴 / Change Log

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2025-10-15 | 初版作成 | GitHub Copilot |

