# issue GitHub Copilot Coding Agent のPRをレビューして気付いたが、ruff formatがかかっていない。PRする前にruff formatをかけてほしい #87
[issues #87](https://github.com/cat2151/cat-file-watcher/issues/87)

## 問題の概要
GitHub Copilot Coding AgentがPRを作成する際、ruff formatが実行されていないコードが含まれることがある。PR作成前にruff formatを適用してほしい。

## 代替案の検討

### 1. 日次バッチでmainにruff formatをかける
**メリット:**
- セキュリティ的に安全
- 定期的にコードフォーマットを保証

**デメリット:**
- PRレビュー時にはまだフォーマットされていない
- PR作成後のフォーマット修正が必要
- 即座の問題解決にならない

**結論:** 補完的な解決策としては有効だが、主要な解決策としては不十分

### 2. AGENTS.mdでcommit前のruff formatを指示する
**調査結果:**
- AGENTS.mdというファイルは存在しない
- GitHub Copilotは `.github/copilot-instructions.md` を読む
- このファイルにruff format実行の指示を追加することが可能

**メリット:**
- GitHub Copilot Agentが直接読む指示ファイルに追加できる
- すぐに実装可能
- 追加コストなし

**デメリット:**
- Agentが指示を無視する可能性がある
- 強制力はない

**結論:** 最も実用的で即座に実装可能な解決策

### 3. pre-commitを利用する
**調査結果:**
- pre-commitはローカル開発環境では有効
- CI/CD環境（GitHub Actions等）でAgentが動作する場合、pre-commit hookは実行されない可能性が高い
- Agentの実行環境に依存する

**メリット:**
- ローカル開発者には有効
- 標準的なツール
- 設定が簡単

**デメリット:**
- GitHub Copilot AgentのCI/CD環境では機能しない可能性が高い
- Agent環境にpre-commitがインストールされている保証がない

**結論:** ローカル開発者向けの補助的な解決策として有効だが、主要な解決策にはならない

### 4. その他の候補

#### GitHub Actions workflow（すでに検討済み・却下）
- Issue #71, #67, #74で検討・実装・最終的に削除
- セキュリティリスク（PWN Request脆弱性）のため削除
- Botからの承認が毎回必要で、自動化できない
- **結論:** セキュリティ上の理由で採用不可

#### report_progress tool経由での自動実行
- GitHub Copilot Agentが使用するreport_progressツール内でruff formatを自動実行
- **問題:** ツールの仕様変更が必要で、制御不可能
- **結論:** 実装不可能

## 実装した解決策

### 主要解決策: `.github/copilot-instructions.md`の更新

以下のセクションを追加:
- **Code Formatting and Quality** セクション
- commit前に必須で実行すべきruffコマンドの明記
- なぜこれが重要かの説明（セキュリティ理由でGitHub Actions削除）
- Best Practicesにもruff実行を明記

**期待される効果:**
- GitHub Copilot Agentが指示を読んで従う
- コミット前にruff formatとruff checkを実行
- フォーマットされていないコードのPRを防ぐ

### 補助的解決策: `.pre-commit-config.yaml`の追加

ローカル開発者向けにpre-commit設定を追加:
- ruff linterとformatterを自動実行
- `pre-commit install`で有効化可能
- ローカル開発でのコード品質向上

**期待される効果:**
- ローカル開発者がコミット前に自動でruffを実行できる
- Agentには効果がない可能性が高いが、開発者エクスペリエンス向上

## 検証方法

1. このPRがマージされた後、次回のGitHub Copilot Agent PRで検証
2. Agentが作成したコードがruff formatされているか確認
3. PR descriptionやcommit messageにruff実行の言及があるか確認

## 今後の改善案

### 短期
- Agentが指示を守っているか監視
- 守られない場合、指示文言の改善を検討

### 長期
- GitHub Actionsでruff checkのみ実行（formatはしない）を検討
  - pull_requestトリガー使用（セキュリティ安全）
  - チェックのみなのでwrite権限不要
  - 失敗時はPRマージをブロック

## 参考資料
- Issue #71: agentによるPRに対して、自動でRuffの実行がされず、承認が必要
- Issue #67: RuffによるformatをGitHub Actionsで自動実行（後に削除）
- Issue #74: GitHub ActionsによるRuff実行でagentのPRがブロック
- issue-notes/71-investigation-report.md: セキュリティ調査報告書
